<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>–ì—ñ—Å—Ç—å</title>
</head>
<body>

<h1>üë§ –ì—ñ—Å—Ç—å</h1>
<div id="user"></div>

<button onclick="logout()">–í–∏–π—Ç–∏</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyX9sLQl6M7HftZhA1WccI_uo6JmxGm1DzifsFmVp4BzPcZQSyd8HixmQ-_igGZeryu/exec";
const REQUIRED_ROLE = "guest";         // ‚Üê –∑–º—ñ–Ω—é—î—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
const IDLE_MINUTES = 5;                // ‚Üê —Ç–≤—ñ–π –ø—É–Ω–∫—Ç ‚Äú5‚Äù

let idleTimer = null;

function logout(){
  localStorage.clear();
  location.href = "index.html";
}

function startIdleTimer(){
  const ms = IDLE_MINUTES * 60 * 1000;
  clearTimeout(idleTimer);
  idleTimer = setTimeout(()=> logout(), ms);
}

// —Å–∫–∏–¥ —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ –±—É–¥—å-—è–∫—É –¥—ñ—é
["click","mousemove","keydown","scroll","touchstart"].forEach(ev=>{
  document.addEventListener(ev, startIdleTimer, {passive:true});
});
startIdleTimer();

function showLastLogin(text){
  const el = document.getElementById("lastLogin");
  if (!el) return;
  el.textContent = text ? `–û—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ö—ñ–¥: ${text}` : `–û—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ö—ñ–¥: ‚Äî`;
}

function applyPermissions(role){
  // –ü–æ–∫–∞–∑/—Å—Ö–æ–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–º data-role="admin,–º–æ–¥–µ—Ä–∞—Ç–æ—Ä"
  document.querySelectorAll("[data-role]").forEach(el=>{
    const list = el.getAttribute("data-role").split(",").map(s=>s.trim());
    el.style.display = list.includes(role) ? "" : "none";
  });
}

(async function checkAccess(){
  const token = localStorage.getItem("dimobl_token");
  const role  = localStorage.getItem("dimobl_role");
  const name  = localStorage.getItem("dimobl_name");

  if (!token || role !== REQUIRED_ROLE) return logout();

  try{
    const r = await fetch(`${API_URL}?action=check&token=${encodeURIComponent(token)}`);
    const d = await r.json();
    if (d.status !== "OK") return logout();

    // —è–∫—â–æ —Ä–æ–ª—å/—ñ–º'—è –∑–º—ñ–Ω–∏–ª–∏—Å—å ‚Äî –æ–Ω–æ–≤–∏–º–æ
    localStorage.setItem("dimobl_role", d.role);
    localStorage.setItem("dimobl_name", d.name);

    if (d.role !== REQUIRED_ROLE) return logout();

    const userEl = document.getElementById("user");
    if (userEl) userEl.textContent = `${d.name} (${d.role})`;

    showLastLogin(d.lastLogin || localStorage.getItem("dimobl_lastLogin") || "");
    applyPermissions(d.role);

  }catch{
    logout();
  }
})();
</script>

  
</body>
</html>
